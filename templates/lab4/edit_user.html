{% extends "base.html" %}

{% block lab %}Лабораторная работа 4{% endblock %}

{% block main %}
    <h1>Редактирование данных</h1>
    
    <div style="max-width: 500px; margin: 0 auto;">
        <form method="post">
            <div style="margin-bottom: 15px;">
                <label for="login" style="display: block; margin-bottom: 5px; font-weight: bold;">Логин:</label>
                <input type="text" id="login" name="login" value="{{ user.login }}" 
                       style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" required>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="name" style="display: block; margin-bottom: 5px; font-weight: bold;">Имя:</label>
                <input type="text" id="name" name="name" value="{{ user.name }}" 
                       style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" required>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="password" style="display: block; margin-bottom: 5px; font-weight: bold;">Новый пароль (оставьте пустым, если не хотите менять):</label>
                <div style="position: relative;">
                    <input type="password" id="password" name="password" 
                           style="position: absolute; left: -9999px;">
                    <input type="text" id="password-display" autocomplete="new-password" placeholder="Введите новый пароль" 
                           style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; letter-spacing: 2px;">
                </div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="password_confirm" style="display: block; margin-bottom: 5px; font-weight: bold;">Подтверждение нового пароля:</label>
                <div style="position: relative;">
                    <input type="password" id="password_confirm" name="password_confirm" 
                           style="position: absolute; left: -9999px;">
                    <input type="text" id="password-confirm-display" autocomplete="new-password" placeholder="Повторите новый пароль" 
                           style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; letter-spacing: 2px;">
                </div>
            </div>
            
            {% if error %}
                <div style="color: red; background-color: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                    {{ error }}
                </div>
            {% endif %}
            
            <button type="submit" style="background-color: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                Сохранить изменения
            </button>
            
            <a href="/lab4/users" style="margin-left: 15px; color: #757575;">Отмена</a>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Функция для создания маскированного поля
            function createPasswordMask(realInputId, displayInputId, placeholder) {
                const realInput = document.getElementById(realInputId);
                const displayInput = document.getElementById(displayInputId);
                
                if (placeholder) {
                    displayInput.placeholder = placeholder;
                }
                
                displayInput.addEventListener('input', function(e) {
                    const value = e.target.value;
                    
                    // Если пользователь добавляет символы
                    if (value.length > realInput.value.length) {
                        const newChar = value.slice(-1);
                        realInput.value += newChar;
                        displayInput.value = '*'.repeat(realInput.value.length);
                    } 
                    // Если пользователь удаляет символы
                    else if (value.length < realInput.value.length) {
                        realInput.value = realInput.value.slice(0, -1);
                        displayInput.value = '*'.repeat(realInput.value.length);
                    }
                    
                    // Всегда устанавливаем курсор в конец
                    displayInput.setSelectionRange(displayInput.value.length, displayInput.value.length);
                });
                
                // Предотвращаем вставку в поле отображения
                displayInput.addEventListener('paste', function(e) {
                    e.preventDefault();
                    alert('Вставка в поле пароля запрещена');
                });
                
                // Обработка клавиш для лучшего UX
                displayInput.addEventListener('keydown', function(e) {
                    // Разрешаем стандартные клавиши управления
                    if (e.key === 'Backspace' || e.key === 'Delete' || e.key === 'ArrowLeft' || 
                        e.key === 'ArrowRight' || e.key === 'Tab' || e.key === 'Home' || e.key === 'End') {
                        return;
                    }
                    
                    // Предотвращаем ввод пробела
                    if (e.key === ' ') {
                        e.preventDefault();
                    }
                });
                
                return { realInput, displayInput };
            }
            
            // Создаем маски для обоих полей пароля
            const passwordMask = createPasswordMask('password', 'password-display', 'Введите новый пароль');
            const confirmMask = createPasswordMask('password_confirm', 'password-confirm-display', 'Повторите новый пароль');
            
            // Обработчик сброса формы (при нажатии на ссылку "Отмена")
            document.querySelector('a[href="/lab4/users"]').addEventListener('click', function() {
                passwordMask.realInput.value = '';
                passwordMask.displayInput.value = '';
                confirmMask.realInput.value = '';
                confirmMask.displayInput.value = '';
            });
            
            // Валидация перед отправкой
            document.querySelector('form').addEventListener('submit', function(e) {
                const password = passwordMask.realInput.value;
                const confirmPassword = confirmMask.realInput.value;
                
                // Если введен пароль, проверяем его
                if (password || confirmPassword) {
                    // Проверяем совпадение паролей
                    if (password !== confirmPassword) {
                        e.preventDefault();
                        alert('Пароли не совпадают!');
                        return;
                    }
                    
                    // Проверяем минимальную длину пароля (если пароль введен)
                    if (password && password.length < 6) {
                        e.preventDefault();
                        alert('Пароль должен содержать минимум 6 символов!');
                        return;
                    }
                }
                
                // Если поля пароля пустые, очищаем их перед отправкой
                if (!password) {
                    passwordMask.realInput.value = '';
                }
                if (!confirmPassword) {
                    confirmMask.realInput.value = '';
                }
            });
            
            // Очистка полей при загрузке страницы (на случай возврата назад)
            window.addEventListener('pageshow', function() {
                passwordMask.realInput.value = '';
                passwordMask.displayInput.value = '';
                confirmMask.realInput.value = '';
                confirmMask.displayInput.value = '';
            });
        });
    </script>
{% endblock %}